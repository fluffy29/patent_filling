<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filing Wizard - Patent Filing Platform</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="wizard-page">

<div class="wizard-container">
    <div class="wizard-header">
        <h1>Patent Filing Wizard</h1>
        <div class="wizard-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p class="progress-text">Step <span id="currentStep">1</span> of 7</p>
        </div>
    </div>

    <form id="wizardForm" class="wizard-form">
        
        <!-- STEP 1: Title & Abstract -->
        <div class="wizard-step active" data-step="1">
            <h2><span class="step-number">1</span> Describe Your Invention</h2>
            <div class="form-group">
                <label for="title">Invention Title</label>
                <input type="text" id="title" name="title" required 
                       placeholder="e.g., Smart Water Bottle with Hydration Tracking">
            </div>
            <div class="form-group">
                <label for="abstract">Abstract (Brief Summary)</label>
                <textarea id="abstract" name="abstract" rows="4" required
                          placeholder="Provide a concise description of your invention (100-150 words)"></textarea>
                <small>Describe what your invention is and what it does</small>
            </div>
        </div>

        <!-- STEP 2: Problem -->
        <div class="wizard-step" data-step="2">
            <h2><span class="step-number">2</span> Problem Your Invention Solves</h2>
            <div class="form-group">
                <label for="problem">What problem does this solve?</label>
                <textarea id="problem" name="problem" rows="5" required
                          placeholder="Describe the problem or need that your invention addresses"></textarea>
                <small>Be specific about the challenges people face without your invention</small>
            </div>
        </div>

        <!-- STEP 3: Target Audience -->
        <div class="wizard-step" data-step="3">
            <h2><span class="step-number">3</span> Target Audience</h2>
            <div class="form-group">
                <label for="audience">Who will use this invention?</label>
                <textarea id="audience" name="audience" rows="5" required
                          placeholder="Describe the intended users, market, or industry"></textarea>
                <small>Consider demographics, industries, or use cases</small>
            </div>
        </div>

        <!-- STEP 4: Technical Description -->
        <div class="wizard-step" data-step="4">
            <h2><span class="step-number">4</span> Technical Description</h2>
            <div class="form-group">
                <label for="description">How does your invention work?</label>
                <textarea id="description" name="description" rows="6" required
                          placeholder="Provide a detailed technical explanation of how your invention functions"></textarea>
                <small>Include materials, components, processes, or methods</small>
            </div>
        </div>

        <!-- STEP 5: Claims -->
        <div class="wizard-step" data-step="5">
            <h2><span class="step-number">5</span> Patent Claims</h2>
            <div class="claims-tools">
                <button type="button" class="btn-secondary" onclick="generateClaims()">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                    </svg>
                    Auto-Generate Claims
                </button>
                <small>Click to generate suggested claims based on your description</small>
            </div>
            <div class="form-group">
                <label for="claims">Claims</label>
                <textarea id="claims" name="claims" rows="8" required
                          placeholder="Patent claims define the legal scope of your invention. Use the auto-generator for help!"></textarea>
                <small>Claims should be clear, specific, and describe novel aspects</small>
            </div>
        </div>

        <!-- STEP 6: Sketches (Optional) -->
        <div class="wizard-step" data-step="6">
            <h2><span class="step-number">6</span> Upload Sketches (Optional)</h2>
            <div class="upload-zone">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
                </svg>
                <p>Upload drawings, diagrams, or prototypes</p>
                <input type="file" id="sketches" accept="image/*,.pdf" multiple>
                <small>Supported: JPG, PNG, PDF</small>
            </div>
            <p class="info-note">Note: File upload functionality coming soon. Skip for now.</p>
        </div>

        <!-- STEP 7: Review & Submit -->
        <div class="wizard-step" data-step="7">
            <h2><span class="step-number">7</span> Review & Submit</h2>
            <div class="review-section">
                <h3>Your Filing Summary</h3>
                <div class="review-item">
                    <strong>Title:</strong>
                    <p id="reviewTitle"></p>
                </div>
                <div class="review-item">
                    <strong>Abstract:</strong>
                    <p id="reviewAbstract"></p>
                </div>
                <div class="review-item">
                    <strong>Problem:</strong>
                    <p id="reviewProblem"></p>
                </div>
                <div class="review-item">
                    <strong>Target Audience:</strong>
                    <p id="reviewAudience"></p>
                </div>
                <div class="review-item">
                    <strong>Technical Description:</strong>
                    <p id="reviewDescription"></p>
                </div>
                <div class="review-item">
                    <strong>Claims:</strong>
                    <p id="reviewClaims"></p>
                </div>
            </div>
            <div id="submitError" class="error-message"></div>
        </div>

        <!-- Navigation Buttons -->
        <div class="wizard-nav">
            <button type="button" class="btn-secondary" id="prevBtn" onclick="changeStep(-1)">
                ‚Üê Previous
            </button>
            <button type="button" class="btn-primary" id="nextBtn" onclick="changeStep(1)">
                Next ‚Üí
            </button>
            <button type="submit" class="btn-primary" id="submitBtn" style="display:none;">
                Submit Filing
            </button>
        </div>
    </form>
</div>

<script src="app.js"></script>
<script>
// Check authentication
checkAuth();

let currentStep = 1;
const totalSteps = 7;

function updateProgress() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('currentStep').textContent = currentStep;
}

function changeStep(direction) {
    const steps = document.querySelectorAll('.wizard-step');
    const currentStepEl = steps[currentStep - 1];
    
    // Validate current step inputs before proceeding
    if (direction === 1) {
        const inputs = currentStepEl.querySelectorAll('input[required], textarea[required]');
        for (let input of inputs) {
            if (!input.value.trim()) {
                alert('Please fill in all required fields before proceeding.');
                return;
            }
        }
    }
    
    // Hide current step
    currentStepEl.classList.remove('active');
    
    // Update step number
    currentStep += direction;
    
    // Show new step
    steps[currentStep - 1].classList.add('active');
    
    // Update buttons
    document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'inline-block';
    document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'inline-block' : 'none';
    
    // Update review on final step
    if (currentStep === totalSteps) {
        updateReview();
    }
    
    updateProgress();
    window.scrollTo(0, 0);
}

function updateReview() {
    document.getElementById('reviewTitle').textContent = document.getElementById('title').value;
    document.getElementById('reviewAbstract').textContent = document.getElementById('abstract').value;
    document.getElementById('reviewProblem').textContent = document.getElementById('problem').value;
    document.getElementById('reviewAudience').textContent = document.getElementById('audience').value;
    document.getElementById('reviewDescription').textContent = document.getElementById('description').value;
    document.getElementById('reviewClaims').textContent = document.getElementById('claims').value;
}

// Mock AI Claims Generator
function generateClaims() {
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    
    if (!title || !description) {
        alert('Please fill in the title and technical description first.');
        return;
    }
    
    // Mock generated claims
    const claims = `1. A ${title.toLowerCase()} comprising:
   - A primary component configured to perform the core function;
   - A secondary component operatively connected to the primary component;
   - A control mechanism for managing the operation;
   
2. The device of claim 1, wherein the primary component includes sensors for data collection.

3. The device of claim 1, further comprising a user interface for interaction.

4. A method for operating ${title.toLowerCase()}, the method comprising:
   - Activating the primary component;
   - Processing data from sensors;
   - Providing output to the user;
   
5. The method of claim 4, wherein processing includes real-time analysis.`;
    
    document.getElementById('claims').value = claims;
    alert('‚úÖ Claims generated! Review and edit as needed.');
}

// Helper: Save filing to localStorage for immediate dashboard display
function saveFilingToLocal(filing) {
    try {
        const list = JSON.parse(localStorage.getItem('demoPatents') || '[]');
        // Attach defaults
        const now = new Date();
        const item = {
            id: filing.id || `local-${now.getTime()}`,
            title: filing.title,
            abstract: filing.abstract,
            problem: filing.problem,
            audience: filing.audience,
            description: filing.description,
            claims: filing.claims,
            status: filing.status || 'submitted',
            filedDate: filing.filedDate || now.toISOString().slice(0,10),
            user: (JSON.parse(localStorage.getItem('user') || '{}').name) || 'local',
            category: filing.category || 'General'
        };
        list.unshift(item);
        localStorage.setItem('demoPatents', JSON.stringify(list));
    } catch (err) {
        console.warn('Local save failed:', err);
    }
}

// Form submission
document.getElementById('wizardForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    const errorDiv = document.getElementById('submitError');
    errorDiv.textContent = '';
    
    const filingData = {
        title: document.getElementById('title').value,
        abstract: document.getElementById('abstract').value,
        problem: document.getElementById('problem').value,
        audience: document.getElementById('audience').value,
        description: document.getElementById('description').value,
        claims: document.getElementById('claims').value
    };
    
    try {
        const response = await fetch('/api/filing/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(filingData)
        });
        
        let data = {};
        try { data = await response.json(); } catch(_) { data = {}; }

        if (!response.ok) {
            // Fallback: save locally so the user sees it in dashboard
            saveFilingToLocal(filingData);
            alert((data && data.error) ? `${data.error}\nSaved locally. You can sync later after login.` : 'Saved locally. You can sync later.');
            window.location.href = 'dashboard.html';
            return;
        }

        // Save to local for immediate visibility in dashboard (use API values when present)
        const saved = data.filing || data;
        saveFilingToLocal({
            id: saved && (saved._id || saved.id),
            ...filingData,
            status: (saved && saved.status) || 'submitted',
            filedDate: (saved && (saved.createdAt || saved.filedDate)) || new Date().toISOString().slice(0,10)
        });

        alert('üéâ Filing submitted successfully!');
        window.location.href = 'dashboard.html';
    } catch (error) {
        console.error('Submission error:', error);
        // Fallback to local save so user still sees the filing
        saveFilingToLocal(filingData);
        alert('You are offline or the server is unavailable. Your filing has been saved locally and will appear in your dashboard.');
        window.location.href = 'dashboard.html';
    }
});

// Initialize
updateProgress();
document.getElementById('prevBtn').style.display = 'none';
</script>

</body>
</html>
